// ==UserScript==
// @name         CommentAssist - Stack Exchange
// @namespace    https://github.com/SpectricSO/stack-scripts
// @version      1.3 (beta)
// @description  Making comments just got easier (NOTICE: BETA)
// @author       SpectricSO
// @match       *://*.askubuntu.com/*
// @match       *://*.mathoverflow.net/*
// @match       *://*.serverfault.com/*
// @match       *://*.stackapps.com/*
// @match       *://*.stackexchange.com/*
// @match       *://*.stackoverflow.com/*
// @match       *://*.superuser.com/*
// @exclude     *://api.stackexchange.com/*
// @exclude     *://blog.*.com/*
// @exclude     *://chat.*.com/*
// @exclude     *://contests.*.com/*
// @exclude     *://data.stackexchange.com/*
// @exclude     *://elections.stackexchange.com/*
// @exclude     *://openid.stackexchange.com/*
// @exclude     *://stackexchange.com/*
// @grant        none
// ==/UserScript==

$(document).ready(function(){var t,e=!1;function s(e,s,n){null!=t&&clearTimeout(t),$(document.body).append(`<div class="s-toast" aria-hidden="true" role="alertdialog" aria-labelledby="notice-message" id="commentassist-notice"><aside class="grid s-notice s-notice__${s}" role="status"><div class="grid--cell mr8"></div><div class="grid--cell lh-lg">${e}</div></aside></div>`),setTimeout(()=>{$("#commentassist-notice").attr("aria-hidden","false")},10),t=setTimeout(()=>{let t=$("#commentassist-notice");t.attr("aria-hidden","true"),setTimeout(()=>{t.remove()},100)},n)}$.getScript("https://cdnjs.cloudflare.com/ajax/libs/pagedown/1.0/Markdown.Converter.min.js").done(function(){$.getScript("https://cdnjs.cloudflare.com/ajax/libs/pagedown/1.0/Markdown.Sanitizer.min.js").done(function(){e=!0}).fail(function(t,e,n){s("Failed to load Markdown preview. If this is a recurring issue, open the developer console, go to the <a href='https://stackapps.com/questions/8987/commentassist-making-comments-just-got-easier'>CommentAssist Post</a> and paste the error message","danger",5e3),console.error("[FOR DEVELOPERS]: Failed to load markdown preview. Debug details: jqxhr ["+t+"] settings ["+e+"] exception ["+n+"] step [2]")})}).fail(function(t,e,n){s("Failed to load Markdown preview. If this is a recurring issue, open the developer console, go to the <a href='https://stackapps.com/questions/8987/commentassist-making-comments-just-got-easier'>CommentAssist Post</a> and paste the error message","danger",5e3),console.error("[FOR DEVELOPERS]: Failed to load markdown preview. Debug details: jqxhr ["+t+"] settings ["+e+"] exception ["+n+"] step [1]")});const n=$('<style>\n.commentassist-container {padding-top: 5px;padding-left: 5px;padding-bottom: 10px;width: 100%;margin: auto;border: 1px solid #bbc0c4;border-radius: 5px 5px 0px 0px;border-bottom: none;margin-bottom: -2px;}.s-textarea.js-comment-text-input {border-top: none;}</style><div class="commentassist-container"><div class="d-flex commentassist-row jc-space-between"><div class="commentassist-options d-flex jc-space-between" style="width:200px"><button class="s-btn s-btn__muted p2 flex--item commentassist-option" data-type="bold" type="button"><span class="icon-bg iconBold"></span></button><button class="s-btn s-btn__muted p2 flex--item commentassist-option" data-type="italics"type="button"><span class="icon-bg iconItalic"></span></button><button class="s-btn s-btn__muted p2 flex--item commentassist-option" data-type="code" type="button"><span class="icon-bg iconCode"></span></button><button class="s-btn s-btn__muted p2 flex--item commentassist-option" data-type="link" type="button"><span class="icon-bg iconLink"></span></button><button class="s-btn s-btn__muted p2 flex--item commentassist-option" data-type="quote" type="button"><span class="icon-bg iconQuote"></span></button></div><div class="d-flex ai-center pr12"><span style="color:var(--black-200);" class="ws-nowrap">CommentAssist by <a href="https://stackoverflow.com/users/14251221/spectric">Spectric</a></span></div></div></div>'),o=$('<div class="commentassist-preview" style="display:none"><nav class="s-breadcrumbs" aria-label="breadcrumb">Preview</nav><div class="commentassist-preview-html"></div></div>'),i={bold:{prefix:"**",suffix:"**"},italics:{prefix:"*",suffix:"*"},code:{prefix:"`",suffix:"`"},link:{prefix:"[](",suffix:")"},quote:{prefix:'*"',suffix:'"*'}};$(".js-add-link.comments-link").on("click",function(){const t=$(this).closest(".js-post-comments-component");setTimeout(function(){const s=t.find(".js-comment-text-input");if($(".commentassist-container",t).length<1&&(n.clone().insertBefore(s),$(".commentassist-option").on("click",function(){const t=$(this).attr("data-type"),e=i[t].prefix,n=i[t].suffix,o=s.prop("selectionStart"),a=s.prop("selectionEnd"),c=s.val(),r=c.substring(0,o)+e+c.substring(o,a)+n+c.substring(a);s.val(r),s.prop("selectionStart",o+e.length),s.prop("selectionEnd",a+e.length),s.focus()}),e)){const t=Markdown.getSanitizingConverter(),e=o.clone();e.insertAfter(s);const n=$(".commentassist-preview-html",e);$(s).on("input change blur focus",function(){const s=t.makeHtml($(this).val()),o=(i=s,(a=(new DOMParser).parseFromString(i,"text/html").body).querySelectorAll("img").forEach(function(t){var e=document.createElement("a");e.href=t.getAttribute("src"),e.innerText=t.alt,$(t).replaceWith(e)}),a.innerHTML);var i,a;n.html(o),0==o.length?e.hide():e.show()})}},50)}),document.addEventListener("keydown",function(t){if(t||(t=event),t.ctrlKey){const s=document.activeElement;if(s.classList.contains("js-comment-text-input")){var e=!0;66==t.keyCode?$('.commentassist-option[data-type="bold"]',$(s).prev()).click():73==t.keyCode?$('.commentassist-option[data-type="italics"]',$(s).prev()).click():75==t.keyCode?$('.commentassist-option[data-type="code"]',$(s).prev()).click():76==t.keyCode?$('.commentassist-option[data-type="link"]',$(s).prev()).click():81==t.keyCode?$('.commentassist-option[data-type="quote"]',$(s).prev()).click():e=!1,e&&t.preventDefault()}}})});
